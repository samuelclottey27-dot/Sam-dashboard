<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sam's Finance">
<meta name="theme-color" content="#070f09">
<title>Sam's Financial Dashboard</title>
<link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Sam%27s%20Financial%20Dashboard%22%2C%22short_name%22%3A%22Sam%27s%20Finance%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23070f09%22%2C%22theme_color%22%3A%22%23070f09%22%2C%22orientation%22%3A%22portrait%22%7D">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%23070f09'/><text x='90' y='128' font-size='110' text-anchor='middle'>üè¶</text></svg>">
<style>
:root {
  --bg:#070f09; --card:#0d1f10; --border:#1a3320;
  --green:#1B5E20; --mid:#2E7D32; --light:#4CAF50;
  --gold:#F9A825; --goldl:#FFD54F; --golddim:#7B6000;
  --text:#E8F5E9; --muted:#7a9e7a;
  --red:#EF5350; --blue:#42A5F5; --orange:#FFA726; --purple:#CE93D8;
  --st: env(safe-area-inset-top,0px); --sb: env(safe-area-inset-bottom,0px);
}
[data-theme="light"] {
  --bg:#f0f4f0; --card:#ffffff; --border:#d0e4d0;
  --green:#2E7D32; --mid:#388E3C; --light:#2E7D32;
  --gold:#E65100; --goldl:#F57C00; --golddim:#BF360C;
  --text:#1a2e1a; --muted:#4a7a4a;
  --red:#C62828; --blue:#1565C0; --orange:#E65100; --purple:#6A1B9A;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Display','Helvetica Neue',sans-serif;overflow:hidden;position:fixed;width:100%;transition:background 0.3s,color 0.3s}
#app{display:flex;flex-direction:column;height:100vh;height:-webkit-fill-available;padding-top:var(--st);padding-bottom:var(--sb);background:var(--bg);position:relative;overflow:hidden}
#app::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 50% at 10% 10%,#1B5E2018 0%,transparent 60%),radial-gradient(ellipse 50% 60% at 90% 90%,#F9A82508 0%,transparent 60%);pointer-events:none;z-index:0}
[data-theme="light"] #app::before{background:radial-gradient(ellipse 70% 50% at 10% 10%,#2E7D3210 0%,transparent 60%)}

/* Header */
#header{flex-shrink:0;padding:12px 14px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(7,15,9,0.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);position:relative;z-index:10}
[data-theme="light"] #header{background:rgba(240,244,240,0.97)}
.hdr-left{display:flex;align-items:center;gap:9px}
.logo{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#F9A825,#2E7D32);display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 0 14px #F9A82540;flex-shrink:0}
.hdr-title{font-size:16px;font-weight:700;color:#fff;letter-spacing:-0.3px}
[data-theme="light"] .hdr-title{color:var(--text)}
.hdr-right{display:flex;align-items:center;gap:8px}
.theme-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:rgba(255,255,255,0.06);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.bal-chip{background:linear-gradient(135deg,#7B600040,#F9A82520);border:1px solid #F9A82540;border-radius:9px;padding:5px 10px;text-align:right;cursor:pointer}
.bal-label{font-size:9px;color:var(--gold);font-weight:600;letter-spacing:0.8px;text-transform:uppercase}
.bal-value{font-size:17px;font-weight:800;letter-spacing:-0.5px}

/* Alert banner */
#alert-banner{display:none;flex-shrink:0;padding:8px 14px;font-size:12px;font-weight:600;text-align:center;z-index:9;animation:slideDown 0.3s ease}
#alert-banner.warn{background:rgba(239,83,80,0.2);border-bottom:1px solid rgba(239,83,80,0.4);color:#EF5350;display:block}
#alert-banner.info{background:rgba(249,168,37,0.15);border-bottom:1px solid rgba(249,168,37,0.3);color:#F9A825;display:block}
@keyframes slideDown{from{opacity:0;transform:translateY(-100%)}to{opacity:1;transform:translateY(0)}}

/* Content */
#content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:13px 13px 18px;position:relative;z-index:1;touch-action:pan-y}

/* Nav */
#nav{flex-shrink:0;display:flex;background:rgba(10,22,12,0.97);border-top:1px solid var(--border);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding-bottom:calc(var(--sb) + 2px);position:relative;z-index:10}
[data-theme="light"] #nav{background:rgba(240,244,240,0.97)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:7px 2px 5px;border:none;background:transparent;cursor:pointer;gap:2px;transition:all 0.2s;position:relative}
.nav-btn::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:2px;background:var(--gold);border-radius:0 0 2px 2px;transition:width 0.25s}
.nav-btn.active::before{width:22px}
.nav-btn .ni{font-size:18px;transition:transform 0.2s}
.nav-btn.active .ni{transform:scale(1.12)}
.nav-btn .nl{font-size:9px;font-weight:600;color:var(--muted);letter-spacing:0.2px}
.nav-btn.active .nl{color:var(--gold)}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;margin-bottom:11px}
.card.glow{border-color:#F9A82550;box-shadow:0 0 18px #F9A82512}
.card-title{font-size:11px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:13px}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:13px 11px;text-align:center}
.kpi-icon{font-size:19px;margin-bottom:4px}
.kpi-val{font-size:19px;font-weight:800;letter-spacing:-0.5px}
.kpi-lbl{font-size:10px;color:var(--muted);margin-top:2px;font-weight:600}

/* Progress */
.prog-track{background:#1a2e1d;border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;transition:width 0.6s cubic-bezier(0.4,0,0.2,1)}
[data-theme="light"] .prog-track{background:#d0e4d0}

/* Ring */
.ring-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center}
.ring-svg{transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:#1a2e1d;stroke-width:8}
[data-theme="light"] .ring-bg{stroke:#d0e4d0}
.ring-fg{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 0.8s cubic-bezier(0.4,0,0.2,1)}
.ring-label{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.ring-pct{font-size:15px;font-weight:800}
.ring-sub{font-size:9px;color:var(--muted);font-weight:600}

/* Section rows */
.sec-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid #1a332035}
.sec-row:last-child{border-bottom:none}
.sec-l{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
.sec-ico{width:29px;height:29px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.sec-name{font-size:13px;font-weight:600;color:var(--text)}
.sec-sub{font-size:10px;color:var(--muted);margin-top:1px}
.sec-r{text-align:right;flex-shrink:0}
.sec-amt{font-size:13px;font-weight:700}
.alert-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-left:5px;vertical-align:middle;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* Budget tab */
.bsh{display:flex;align-items:center;justify-content:space-between;padding:11px 0 7px;border-bottom:1px solid var(--border)}
.bsh-l{display:flex;align-items:center;gap:7px}
.bsh-ttl{font-size:13px;font-weight:700}
.bsh-tot{font-size:13px;font-weight:800}
.budget-5col{display:grid;grid-template-columns:1fr 64px 72px 50px 26px;gap:2px;align-items:center;padding:8px 0;border-bottom:1px solid #1a332025;font-size:12px}
.budget-5col:last-of-type{border-bottom:none}
.bud-editable{display:inline-flex;align-items:center;gap:3px;background:rgba(66,165,245,0.1);border:1px dashed rgba(66,165,245,0.45);border-radius:7px;padding:3px 7px;cursor:pointer;color:#42A5F5;font-weight:700;font-size:11px;transition:all 0.15s}
.bud-editable:active{background:rgba(66,165,245,0.22)}
.act-btn{background:rgba(249,168,37,0.1);border:1px dashed rgba(249,168,37,0.4);border-radius:8px;color:var(--muted);font-size:11px;padding:4px 3px;text-align:center;cursor:pointer;width:100%;font-family:inherit;transition:all 0.15s}
.act-btn.has{color:var(--gold);font-weight:700;border-color:rgba(249,168,37,0.7);background:rgba(249,168,37,0.15)}
.diff-pos{color:#4CAF50} .diff-neg{color:#EF5350} .diff-none{color:var(--muted)}
.del-btn{width:24px;height:24px;border-radius:50%;border:1px solid rgba(239,83,80,0.3);background:rgba(239,83,80,0.08);color:#EF5350;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:inherit;transition:all 0.15s}
.del-btn:active{background:rgba(239,83,80,0.25)}
.add-item-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:5px;background:transparent;border:1px dashed rgba(76,175,80,0.4);border-radius:9px;padding:8px;cursor:pointer;margin-top:7px;color:#4CAF50;font-size:12px;font-weight:600;font-family:inherit;transition:all 0.15s}
.add-item-btn:active{background:rgba(76,175,80,0.1)}
.notes-field{font-size:11px;color:var(--muted);font-style:italic;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.grand-bar{background:linear-gradient(135deg,rgba(27,94,32,0.6),rgba(27,94,32,0.3));border:2px solid rgba(249,168,37,0.5);border-radius:13px;padding:15px;display:flex;flex-direction:column;gap:7px;margin-top:4px;box-shadow:0 0 18px rgba(249,168,37,0.1)}
.gt-row{display:flex;justify-content:space-between;align-items:center}
.gt-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase}
.gt-val{font-size:17px;font-weight:800}

/* Daily expenses */
.exp-form{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;margin-bottom:11px}
.exp-field{display:flex;flex-direction:column;gap:4px;margin-bottom:11px}
.exp-lbl{font-size:11px;color:var(--muted);font-weight:600}
.exp-inp{width:100%;background:rgba(7,15,9,0.6);border:1.5px solid var(--border);border-radius:9px;color:var(--text);font-size:15px;padding:10px 12px;outline:none;font-family:inherit;transition:border-color 0.15s}
[data-theme="light"] .exp-inp{background:rgba(255,255,255,0.8)}
.exp-inp:focus{border-color:var(--gold)}
.exp-2col{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.exp-cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:11px}
.exp-cat-btn{padding:7px 4px;border-radius:9px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:11px;font-weight:600;color:var(--muted);text-align:center;font-family:inherit;transition:all 0.15s}
.exp-cat-btn.sel{border-color:var(--gold);background:rgba(249,168,37,0.15);color:var(--gold)}
.btn-add-exp{width:100%;padding:13px;border-radius:11px;background:linear-gradient(135deg,var(--mid),var(--green));border:none;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:7px}
.btn-add-exp:active{transform:scale(0.98)}
.day-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:11px}
.day-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:11px 7px;text-align:center}
.day-stat-val{font-size:17px;font-weight:800}
.day-stat-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px}
.filter-bar{display:flex;gap:5px;margin-bottom:11px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:2px}
.f-chip{flex-shrink:0;padding:6px 13px;border-radius:99px;border:1px solid var(--border);background:var(--card);color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit;transition:all 0.15s}
.f-chip.on{background:rgba(249,168,37,0.15);border-color:rgba(249,168,37,0.5);color:var(--gold)}
.exp-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:11px 13px;display:flex;align-items:center;gap:11px;margin-bottom:7px}
.exp-ico{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.exp-info{flex:1;min-width:0}
.exp-desc{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.exp-meta{font-size:11px;color:var(--muted);margin-top:2px}
.exp-amt{font-size:15px;font-weight:800;color:var(--gold);flex-shrink:0}
.exp-del{width:27px;height:27px;border-radius:50%;border:1px solid rgba(239,83,80,0.3);background:rgba(239,83,80,0.08);color:#EF5350;font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-family:inherit}

/* Monthly history */
.hist-card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:13px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.hist-month{font-size:14px;font-weight:700;color:var(--text)}
.hist-stats{display:flex;gap:14px;align-items:center}
.hist-stat{text-align:right}
.hist-stat-val{font-size:13px;font-weight:700}
.hist-stat-lbl{font-size:10px;color:var(--muted)}
.hist-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:5px}
.saved-pos{background:rgba(76,175,80,0.2);color:#4CAF50}
.saved-neg{background:rgba(239,83,80,0.2);color:#EF5350}

/* Overlays */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:300;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity 0.2s}
.overlay.open{opacity:1;pointer-events:all}
.sheet{width:100%;background:var(--card);border-radius:20px 20px 0 0;padding:20px 20px calc(20px + var(--sb));transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1)}
.overlay.open .sheet{transform:translateY(0)}
.sh-lbl{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px}
.sh-title{font-size:17px;font-weight:800;color:var(--text);margin-bottom:15px}
.sh-input{width:100%;background:rgba(7,15,9,0.6);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-size:22px;font-weight:800;padding:13px 15px;text-align:center;outline:none;font-family:inherit;letter-spacing:-0.5px;margin-bottom:13px;transition:border-color 0.15s}
[data-theme="light"] .sh-input{background:rgba(255,255,255,0.8)}
.sh-input:focus{border-color:var(--gold)}
.sh-input.blue:focus{border-color:#42A5F5}
.sh-input.sm{font-size:16px;text-align:left;margin-bottom:10px}
.sh-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:10px}
.sh-notes{width:100%;background:rgba(7,15,9,0.6);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;padding:10px 13px;outline:none;font-family:inherit;margin-bottom:13px;resize:none;transition:border-color 0.15s}
[data-theme="light"] .sh-notes{background:rgba(255,255,255,0.8)}
.sh-notes:focus{border-color:var(--gold)}
.btn-row{display:flex;gap:9px}
.btn-cancel{flex:1;padding:13px;border-radius:11px;background:rgba(255,255,255,0.06);border:1px solid var(--border);color:var(--muted);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
.btn-save{flex:2;padding:13px;border-radius:11px;background:linear-gradient(135deg,var(--mid),var(--green));border:none;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 14px rgba(46,125,50,0.4)}
.btn-danger{flex:1;padding:13px;border-radius:11px;background:rgba(239,83,80,0.15);border:1px solid rgba(239,83,80,0.4);color:#EF5350;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}

/* Reset modal */
#reset-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:400;display:none;align-items:center;justify-content:center;padding:20px}
#reset-modal.open{display:flex}
.reset-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:340px}
.reset-title{font-size:18px;font-weight:800;color:var(--text);margin-bottom:8px}
.reset-body{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:20px}
.reset-month{font-size:13px;font-weight:700;color:var(--gold);margin-bottom:14px}

/* Toast */
#toast{position:fixed;bottom:calc(80px + var(--sb));left:50%;transform:translateX(-50%) translateY(20px);background:rgba(13,31,16,0.97);border:1px solid var(--border);border-radius:99px;padding:9px 18px;font-size:13px;font-weight:600;color:var(--text);z-index:500;opacity:0;transition:all 0.3s;pointer-events:none;white-space:nowrap}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* PIN screen */
#pin-screen{position:fixed;inset:0;z-index:500;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 32px calc(40px + var(--sb));padding-top:calc(40px + var(--st))}
#pin-screen.hidden{display:none}
.pin-logo{width:70px;height:70px;border-radius:20px;background:linear-gradient(135deg,#F9A825,#2E7D32);display:flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:18px;box-shadow:0 0 36px #F9A82540;animation:logoPulse 2.5s ease-in-out infinite}
@keyframes logoPulse{0%,100%{box-shadow:0 0 28px #F9A82530}50%{box-shadow:0 0 52px #F9A82560}}
.pin-title{font-size:21px;font-weight:800;color:#fff;letter-spacing:-0.5px;margin-bottom:5px;text-align:center}
.pin-sub{font-size:13px;color:var(--muted);margin-bottom:34px;text-align:center;line-height:1.5}
.pin-step{font-size:12px;color:var(--gold);font-weight:600;margin-bottom:11px;text-align:center;letter-spacing:0.3px}
.pin-dots{display:flex;gap:15px;margin-bottom:9px}
.pin-dot{width:15px;height:15px;border-radius:50%;border:2px solid #F9A82555;background:transparent;transition:all 0.15s cubic-bezier(0.4,0,0.2,1)}
.pin-dot.filled{background:#F9A825;border-color:#F9A825;box-shadow:0 0 10px #F9A82575;transform:scale(1.15)}
.pin-dot.error{background:#EF5350;border-color:#EF5350;box-shadow:0 0 10px #EF535075}
.pin-dot.ok{background:#4CAF50;border-color:#4CAF50;box-shadow:0 0 10px #4CAF5075}
.pin-err{font-size:12px;color:#EF5350;font-weight:600;margin-bottom:18px;min-height:17px;text-align:center;opacity:0;transition:opacity 0.2s}
.pin-err.vis{opacity:1}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;width:100%;max-width:276px;margin-top:7px}
.pin-key{aspect-ratio:1;border-radius:50%;border:1px solid #1a3320;background:rgba(13,31,16,0.8);color:#fff;font-size:21px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1px;transition:all 0.12s;font-family:inherit;user-select:none}
.pin-key:active{background:rgba(249,168,37,0.2);border-color:#F9A82575;transform:scale(0.93)}
.pin-key .kl{font-size:8px;color:var(--muted);font-weight:500;letter-spacing:1px}
.pin-key.empty{border:none;background:transparent;cursor:default}
.pin-key.empty:active{background:transparent;transform:none}
.pin-forgot{margin-top:26px;font-size:12px;color:var(--muted);text-align:center;line-height:1.8}
.pin-forgot span{color:var(--gold);font-weight:600;cursor:pointer;text-decoration:underline}
@keyframes shake{0%,100%{transform:translateX(0)}15%{transform:translateX(-10px)}30%{transform:translateX(10px)}45%{transform:translateX(-8px)}60%{transform:translateX(8px)}75%{transform:translateX(-5px)}90%{transform:translateX(5px)}}
.pin-dots.shake{animation:shake 0.5s ease}
@keyframes pinUp{from{transform:translateY(0);opacity:1}to{transform:translateY(-40px);opacity:0}}
#pin-screen.unlocking{animation:pinUp 0.35s ease forwards;pointer-events:none}

/* Investments tab */
.inv-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px}
.inv-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:13px 11px;position:relative;overflow:hidden}
.inv-name{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.4px;margin-bottom:5px}
.inv-val{font-size:21px;font-weight:900;letter-spacing:-0.8px;margin-bottom:2px}
.inv-sub{font-size:10px;color:var(--muted);margin-bottom:9px}
.slider-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
input[type=range]{-webkit-appearance:none;width:100%;background:transparent}
input[type=range]::-webkit-slider-runnable-track{background:#1a3320;height:6px;border-radius:99px}
[data-theme="light"] input[type=range]::-webkit-slider-runnable-track{background:#d0e4d0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--gold);margin-top:-7px;cursor:pointer;box-shadow:0 0 7px #F9A82555;border:2px solid #fff2}
.m-ticks{display:flex;justify-content:space-between}
.m-tick{font-size:11px;color:var(--muted);cursor:pointer;padding:2px 0}
.m-tick.on{color:var(--gold);font-weight:700}

/* Collapsibles for plan tab */
.coll{border:1px solid var(--border);border-radius:15px;overflow:hidden;margin-bottom:9px}
.coll.open{border-color:rgba(249,168,37,0.35)}
.coll-hdr{width:100%;display:flex;align-items:center;justify-content:space-between;padding:13px 15px;border:none;cursor:pointer;font-family:inherit;background:var(--card);transition:background 0.2s}
.coll.open .coll-hdr{background:rgba(249,168,37,0.06);border-bottom:1px solid rgba(249,168,37,0.18)}
.coll-l{display:flex;align-items:center;gap:9px}
.coll-ico{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.coll-ttl{font-size:13px;font-weight:700;color:#fff;text-align:left}
[data-theme="light"] .coll-ttl{color:var(--text)}
.coll-sub{font-size:11px;color:var(--muted);text-align:left;margin-top:1px}
.coll-chev{width:25px;height:25px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;flex-shrink:0;transition:transform 0.3s}
.coll.open .coll-chev{transform:rotate(180deg)}
.coll-body{background:var(--card);max-height:0;overflow:hidden;transition:max-height 0.4s cubic-bezier(0.4,0,0.2,1)}
.coll.open .coll-body{max-height:2000px}
.coll-inner{padding:15px}

/* Plan tab selectors */
.plan-sel-btn{width:100%;display:flex;align-items:center;justify-content:space-between;background:var(--card);border:2px solid var(--border);border-radius:13px;padding:13px 15px;cursor:pointer;transition:all 0.2s;margin-bottom:11px;font-family:inherit}
.plan-sel-btn.open{border-color:#F9A82570;box-shadow:0 0 18px #F9A82515;background:rgba(249,168,37,0.06)}
.psl{display:flex;align-items:center;gap:9px}
.ps-ico{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#F9A82535,#2E7D3235);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.ps-name{font-size:17px;font-weight:800;color:var(--gold);letter-spacing:-0.3px}
.ps-sub{font-size:11px;color:var(--muted);margin-top:1px}
.chev{color:var(--gold);font-size:15px;font-weight:900;transition:transform 0.3s}
.chev.open{transform:rotate(180deg)}
.plan-drop{background:var(--card);border:2px solid #F9A82545;border-radius:15px;overflow:hidden;margin-bottom:11px;animation:dropIn 0.2s ease}
@keyframes dropIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.yr-tabs{display:flex;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2)}
.yr-tab{flex:1;padding:9px 3px;border:none;cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;background:transparent;color:var(--muted);border-bottom:2px solid transparent;transition:all 0.2s}
.yr-tab.on{color:var(--gold);border-bottom-color:var(--gold);background:rgba(249,168,37,0.08)}
.mo-list{max-height:230px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.mo-opt{width:100%;display:flex;align-items:center;justify-content:space-between;padding:11px 15px;border:none;cursor:pointer;background:transparent;font-family:inherit;border-left:3px solid transparent;transition:all 0.15s}
.mo-opt.sel{background:rgba(249,168,37,0.07);border-left-color:var(--gold)}
.mo-l{display:flex;align-items:center;gap:9px}
.mo-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.mo-name{font-size:13px;color:var(--text);font-weight:500}
.mo-opt.sel .mo-name{color:var(--gold);font-weight:700}
.mo-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px}
.badge-sw{background:rgba(239,83,80,0.2);color:#EF5350}
.badge-ac{background:rgba(249,168,37,0.15);color:#F9A825}
.drop-leg{display:flex;gap:13px;padding:8px 15px;border-top:1px solid var(--border);background:rgba(0,0,0,0.15)}
.leg-i{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted)}
.leg-d{width:6px;height:6px;border-radius:50%}
.phase-badge{display:inline-flex;align-items:center;gap:6px;border-radius:99px;padding:5px 13px;margin-bottom:13px;font-size:12px;font-weight:700}
.p-dot{width:7px;height:7px;border-radius:50%}
.plan-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:13px}
.ps-stat{background:var(--card);border:1px solid var(--border);border-radius:11px;padding:11px 7px;text-align:center}
.ps-sv{font-size:15px;font-weight:800}
.ps-sl{font-size:9px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px}
.plan-tbl-hdr{display:grid;grid-template-columns:1fr 68px 68px 56px;font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;padding-bottom:7px;border-bottom:1px solid var(--border)}
.plan-tbl-hdr span:not(:first-child){text-align:right}
.plan-row{display:grid;grid-template-columns:1fr 68px 68px 56px;align-items:center;padding:9px 0;border-bottom:1px solid rgba(26,51,32,0.25)}
.plan-row:last-child{border-bottom:none}
.pr-l{display:flex;align-items:center;gap:6px}
.pr-name{font-size:12px;font-weight:600;color:var(--text)}
.pr-sub{font-size:10px;font-weight:700;margin-top:1px}
.plan-row span{font-size:12px;font-weight:600;text-align:right}
.plan-tot-row{display:grid;grid-template-columns:1fr 68px 68px 56px;align-items:center;padding:11px 0 3px;border-top:2px solid var(--border);margin-top:3px}
.plan-tot-row span{font-size:12px;font-weight:800;text-align:right}
.plan-tot-row span:first-child{text-align:left;color:#fff}
[data-theme="light"] .plan-tot-row span:first-child{color:var(--text)}
.plan-bal{background:rgba(249,168,37,0.1);border:1px solid rgba(249,168,37,0.25);border-radius:9px;padding:11px 13px;margin-top:9px;display:flex;justify-content:space-between;align-items:center}
.redir-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:11px}
.redir-card{background:rgba(249,168,37,0.05);border:1px solid rgba(249,168,37,0.18);border-radius:11px;padding:11px;text-align:center}
.rc-ico{font-size:19px;margin-bottom:5px}
.rc-amt{font-size:17px;font-weight:800;color:var(--gold)}
.rc-pct{font-size:10px;color:var(--gold);font-weight:600;margin-bottom:3px}
.rc-lbl{font-size:11px;color:var(--muted);line-height:1.3}
.inv-prog-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:11px}
.ipc{background:rgba(13,31,16,0.5);border:1px solid var(--border);border-radius:9px;padding:9px;text-align:center}
[data-theme="light"] .ipc{background:rgba(255,255,255,0.6)}
.ipc-name{font-size:10px;color:var(--muted);margin-bottom:3px;line-height:1.3}
.ipc-val{font-size:15px;font-weight:800;color:var(--gold)}
.ipc-sub{font-size:10px;color:var(--muted);margin-top:1px}

/* Swipe indicator */
#swipe-hint{position:fixed;bottom:calc(60px + var(--sb));left:50%;transform:translateX(-50%);font-size:11px;color:var(--muted);opacity:0;transition:opacity 0.5s;pointer-events:none;z-index:5}

/* Install banner */
#install-banner{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#0d1f10,#1B5E20);border-top:2px solid var(--gold);padding:13px 15px calc(13px + var(--sb));z-index:200;display:flex;align-items:center;gap:11px;animation:slideUp 0.4s cubic-bezier(0.4,0,0.2,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
#install-banner.hidden{display:none}
.inst-txt{flex:1;font-size:12px;color:var(--text);line-height:1.4}
.inst-later{background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;padding:7px 11px;cursor:pointer;font-family:inherit;flex-shrink:0}

::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--mid);border-radius:99px}
@keyframes dropIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- PIN Screen -->
<div id="pin-screen">
  <div class="pin-logo">üè¶</div>
  <div class="pin-title">Sam's Financial Dashboard</div>
  <div class="pin-sub" id="pin-sub">Enter your PIN to unlock</div>
  <div class="pin-step" id="pin-step" style="display:none"></div>
  <div class="pin-dots" id="pin-dots">
    <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-err" id="pin-err"></div>
  <div class="pin-pad">
    <button class="pin-key" onclick="pk('1')">1</button>
    <button class="pin-key" onclick="pk('2')">2<div class="kl">ABC</div></button>
    <button class="pin-key" onclick="pk('3')">3<div class="kl">DEF</div></button>
    <button class="pin-key" onclick="pk('4')">4<div class="kl">GHI</div></button>
    <button class="pin-key" onclick="pk('5')">5<div class="kl">JKL</div></button>
    <button class="pin-key" onclick="pk('6')">6<div class="kl">MNO</div></button>
    <button class="pin-key" onclick="pk('7')">7<div class="kl">PQRS</div></button>
    <button class="pin-key" onclick="pk('8')">8<div class="kl">TUV</div></button>
    <button class="pin-key" onclick="pk('9')">9<div class="kl">WXYZ</div></button>
    <button class="pin-key empty"></button>
    <button class="pin-key" onclick="pk('0')">0</button>
    <button class="pin-key" onclick="pdel()">‚å´</button>
  </div>
  <div class="pin-forgot" id="pin-forgot">Forgot PIN? <span onclick="pinReset()">Reset dashboard PIN</span></div>
</div>

<!-- App Shell -->
<div id="app">
  <div id="alert-banner" id="alert-banner"></div>

  <div id="header">
    <div class="hdr-left">
      <div class="logo">üè¶</div>
      <div class="hdr-title">Sam's Dashboard</div>
    </div>
    <div class="hdr-right">
      <button class="theme-btn" onclick="toggleTheme()" id="theme-btn">üåô</button>
      <div class="bal-chip" onclick="openIncomeEdit()">
        <div class="bal-label">Balance ‚úèÔ∏è</div>
        <div class="bal-value" id="hdr-bal" style="color:#F9A825">‚Äî</div>
      </div>
    </div>
  </div>

  <div id="content"></div>

  <nav id="nav">
    <button class="nav-btn active" data-tab="overview" onclick="goTab('overview')"><span class="ni">‚óà</span><span class="nl">Overview</span></button>
    <button class="nav-btn" data-tab="budget" onclick="goTab('budget')"><span class="ni">‚óâ</span><span class="nl">Budget</span></button>
    <button class="nav-btn" data-tab="daily" onclick="goTab('daily')"><span class="ni">‚ú¶</span><span class="nl">Daily</span></button>
    <button class="nav-btn" data-tab="invest" onclick="goTab('invest')"><span class="ni">‚óÜ</span><span class="nl">Invest</span></button>
    <button class="nav-btn" data-tab="plan" onclick="goTab('plan')"><span class="ni">‚óá</span><span class="nl">Plan</span></button>
  </nav>
</div>

<!-- Actual amount input overlay -->
<div class="overlay" id="act-ov" onclick="closeActOv(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sh-lbl" id="act-cat"></div>
    <div class="sh-title" id="act-item"></div>
    <input class="sh-input" id="act-inp" type="number" inputmode="decimal" placeholder="0">
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeActOv()">Cancel</button>
      <button class="btn-save" onclick="saveAct()">Save ‚Çµ</button>
    </div>
  </div>
</div>

<!-- Budget item edit overlay -->
<div class="overlay" id="bud-ov" onclick="closeBudOv(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sh-lbl" id="bud-sec-lbl"></div>
    <div class="sh-title" id="bud-mode-ttl">Edit Item</div>
    <div style="margin-bottom:8px"><div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:5px">Item Name</div>
    <input class="sh-input sm blue" id="bud-name" type="text" placeholder="e.g. Rent"></div>
    <div style="margin-bottom:13px"><div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:5px">Budget Amount (‚Çµ)</div>
    <input class="sh-input sm" id="bud-amt" type="number" inputmode="decimal" placeholder="0"></div>
    <div style="margin-bottom:13px"><div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:5px">Notes (optional)</div>
    <textarea class="sh-notes" id="bud-notes" rows="2" placeholder="e.g. GTBank auto-debit, ref 1234"></textarea></div>
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeBudOv()">Cancel</button>
      <button class="btn-save" id="bud-save-btn" onclick="saveBudItem()">Save</button>
    </div>
  </div>
</div>

<!-- Income edit overlay -->
<div class="overlay" id="inc-ov" onclick="closeIncOv(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sh-lbl">Monthly Income</div>
    <div class="sh-title">Update income (GHS)</div>
    <input class="sh-input" id="inc-inp" type="number" inputmode="decimal" placeholder="10000">
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeIncOv()">Cancel</button>
      <button class="btn-save" onclick="saveIncome()">Update ‚Çµ</button>
    </div>
  </div>
</div>

<!-- Monthly Reset modal -->
<div id="reset-modal">
  <div class="reset-box">
    <div class="reset-title">üìÖ Start New Month</div>
    <div class="reset-body">This will archive <strong id="rm-cur-month"></strong>'s data to history and clear all actuals for a fresh start.</div>
    <div style="display:flex;gap:9px">
      <button class="btn-cancel" style="flex:1" onclick="closeResetModal()">Cancel</button>
      <button class="btn-danger" style="flex:1" onclick="confirmReset()">Archive & Reset</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Install banner -->
<div id="install-banner" class="hidden">
  <div class="inst-txt"><strong>üì≤ Add to Home Screen</strong><br>Tap <strong>Share ‚Üí Add to Home Screen</strong> in Safari to install offline!</div>
  <button class="inst-later" onclick="dismissInstall()">Got it</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MONTHS_N = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const CAT_ICONS = {food:'üçΩÔ∏è',transport:'üöó',personal:'üíÜ',health:'üè•',social:'üéâ',shopping:'üõçÔ∏è',bills:'üìÑ',other:'üí∞'};
const CAT_COLORS = {food:'#FFA726',transport:'#42A5F5',personal:'#CE93D8',health:'#EF5350',social:'#F9A825',shopping:'#4CAF50',bills:'#7a9e7a',other:'#FFD54F'};
const REDIRECTIONS = [
  {label:'Extra Investments',amount:600,pct:'30%',icon:'üìà'},
  {label:'Emergency Fund Top-Up',amount:500,pct:'25%',icon:'üõ°Ô∏è'},
  {label:'Long-term Savings',amount:300,pct:'15%',icon:'üè¶'},
  {label:'Sinking Fund / Buffer',amount:200,pct:'10%',icon:'üîí'},
  {label:'Debt Final Sweep',amount:200,pct:'10%',icon:'üí≥'},
  {label:'Lifestyle Reward',amount:200,pct:'10%',icon:'üéâ'},
];

const DEFAULT_SECTIONS = [
  {id:'housing',label:'Housing & Fixed',icon:'üè†',color:'#4CAF50',items:[
    {n:'Rent / Accommodation',b:5000,notes:''},{n:'Electricity & Water',b:400,notes:''},{n:'Internet & WiFi',b:200,notes:''},{n:'Other Housing',b:100,notes:''}]},
  {id:'church',label:'Church & Community',icon:'‚õ™',color:'#FFA726',items:[
    {n:'Tithe / Church Offerings',b:700,notes:''},{n:'Church Events & Programs',b:100,notes:''}]},
  {id:'data',label:'Data & Subscriptions',icon:'üì±',color:'#42A5F5',items:[
    {n:'Mobile Data Bundles',b:200,notes:''},{n:'Streaming Services',b:150,notes:''},{n:'Other Subscriptions',b:50,notes:''}]},
  {id:'family',label:'Family Support',icon:'üë®‚Äçüë©‚Äçüëß',color:'#CE93D8',items:[
    {n:'Monthly Family Upkeep',b:400,notes:''},{n:'Special Family Needs',b:200,notes:''}]},
  {id:'payments',label:'Personal Payments',icon:'üí≥',color:'#EF5350',endsJune:true,items:[
    {n:'Loan Repayment #1',b:1000,notes:''},{n:'Loan Repayment #2',b:700,notes:''},{n:'Other Commitments',b:300,notes:''}]},
  {id:'invest',label:'Investments',icon:'üìà',color:'#FFD54F',items:[
    {n:'Stocks & ETFs',b:1000,notes:''},{n:'Treasury Bills (T-Bills)',b:500,notes:''},{n:'Money Market Fund',b:300,notes:''},{n:'Mutual Fund',b:200,notes:''}]},
  {id:'savings',label:'Savings',icon:'üè¶',color:'#F9A825',items:[
    {n:'Emergency Fund',b:500,notes:''},{n:'Short-Term Goals',b:200,notes:''},{n:'Sinking Funds',b:150,notes:''}]},
  {id:'personal',label:'Personal & Lifestyle',icon:'üéâ',color:'#7a9e7a',items:[
    {n:'Groceries & Food',b:400,notes:''},{n:'Transport / Fuel',b:300,notes:''},{n:'Eating Out / Social',b:150,notes:''},{n:'Personal Care',b:100,notes:''},{n:'Miscellaneous',b:50,notes:''}]},
];

const INV_VEHICLES = [
  {name:'Stocks & ETFs',monthly:1000,color:'#F9A825'},
  {name:'Treasury Bills',monthly:500,color:'#4CAF50'},
  {name:'Money Market Fund',monthly:300,color:'#42A5F5'},
  {name:'Mutual Fund',monthly:200,color:'#CE93D8'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let INCOME = 10000;
let SECTIONS = JSON.parse(JSON.stringify(DEFAULT_SECTIONS));

let S = {
  tab:'overview', theme:'dark', invMonth:1,
  actuals:{}, dailyExpenses:[], dailyFilter:'all', dailyExpCat:'other',
  monthHistory:[],
  planIdx:0, planDrop:false, planYear:null,
  colls:{breakdown:true,redirect:true,preview:false,invprog:false},
  currentMonthLabel:'',
};

// Load from localStorage
try {
  const raw = localStorage.getItem('sams_v3');
  if (raw) {
    const p = JSON.parse(raw);
    Object.assign(S, p);
    if (p.income) INCOME = p.income;
    if (p.sections) SECTIONS = p.sections;
  }
} catch(e) {}

// Set current month label if not set
if (!S.currentMonthLabel) {
  const n = new Date();
  S.currentMonthLabel = MONTHS_N[n.getMonth()] + ' ' + n.getFullYear();
}

function save() {
  try {
    localStorage.setItem('sams_v3', JSON.stringify({
      ...S, income:INCOME,
      sections: SECTIONS.map(s=>({...s,items:s.items.map(i=>({...i}))})),
    }));
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DERIVED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fmt = n => Math.round(n).toLocaleString();
const fmtD = n => parseFloat(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
function totalBudget() { return SECTIONS.reduce((a,s)=>a+s.items.reduce((b,i)=>b+i.b,0),0); }
function secBudget(id) { return SECTIONS.find(s=>s.id===id)?.items.reduce((a,i)=>a+i.b,0)||0; }
function secActual(id) { const sec=SECTIONS.find(s=>s.id===id); return sec?sec.items.reduce((a,i)=>a+(S.actuals[id+'_'+i.n]||0),0):0; }
function budgetActualsTotal() { return Object.values(S.actuals).reduce((a,v)=>a+v,0); }
function dailyTotal() { return S.dailyExpenses.reduce((a,e)=>a+e.amount,0); }
function totalSpent() { return budgetActualsTotal()+dailyTotal(); }
function balance() { return INCOME - totalSpent(); }
function todayStr() { return new Date().toISOString().slice(0,10); }
function monthStr() { return new Date().toISOString().slice(0,7); }
function genMonthOpts() {
  const opts=[];
  for(let y=2026;y<=2030;y++){const ms=y===2026?1:0;for(let m=ms;m<12;m++)opts.push({month:m,year:y,label:`${MONTHS_N[m]} ${y}`});}
  return opts;
}
const MONTH_OPTS = genMonthOpts();
function isAfterJune(m,y){return y>2026||(y===2026&&m>5);}
function mnSince(m,y){return(y-2026)*12+(m-1);}
function getPlan(m,y){
  const after=isAfterJune(m,y);const mnum=mnSince(m,y);
  const base=[
    {label:'Housing & Fixed',icon:'üè†',color:'#4CAF50',before:5700,after:5700},
    {label:'Church & Community',icon:'‚õ™',color:'#FFA726',before:800,after:800},
    {label:'Data & Subscriptions',icon:'üì±',color:'#42A5F5',before:400,after:400},
    {label:'Family Support',icon:'üë®‚Äçüë©‚Äçüëß',color:'#CE93D8',before:600,after:600},
    {label:'Personal Payments',icon:'üí≥',color:'#EF5350',before:2000,after:0,ended:true},
    {label:'Investments',icon:'üìà',color:'#F9A825',before:2000,after:2600,change:'+‚Çµ600'},
    {label:'Savings',icon:'üè¶',color:'#FFD54F',before:850,after:1350,change:'+‚Çµ500'},
    {label:'Personal & Lifestyle',icon:'üéâ',color:'#7a9e7a',before:1000,after:1000},
  ];
  const rows=base.map(r=>({...r,current:after?r.after:r.before}));
  return{rows,totalOut:rows.reduce((a,r)=>a+r.current,0),after,mnum};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyTheme() {
  document.documentElement.setAttribute('data-theme', S.theme);
  document.getElementById('theme-btn').textContent = S.theme==='dark'?'‚òÄÔ∏è':'üåô';
}
function toggleTheme() {
  S.theme = S.theme==='dark'?'light':'dark';
  applyTheme(); save();
  navigator.vibrate&&navigator.vibrate(30);
}
applyTheme();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAlert() {
  const banner = document.getElementById('alert-banner');
  if (!banner) return;
  const overBudget = SECTIONS.filter(s=>{const sb=secBudget(s.id),sa=secActual(s.id);return sa>0&&sa>=sb*0.8;});
  if (overBudget.length>0) {
    const over100 = overBudget.filter(s=>secActual(s.id)>=secBudget(s.id));
    if (over100.length>0) {
      banner.className='warn';
      banner.textContent=`‚ö†Ô∏è Over budget: ${over100.map(s=>s.label).join(', ')}`;
    } else {
      banner.className='info';
      banner.textContent=`üìä 80%+ used in: ${overBudget.map(s=>s.label).join(', ')}`;
    }
  } else { banner.className=''; banner.textContent=''; banner.style.display='none'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HAPTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const vib = (p=20)=>navigator.vibrate&&navigator.vibrate(p);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg,dur=2200) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SWIPE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TABS = ['overview','budget','daily','invest','plan'];
let swipeStartX=0, swipeStartY=0, swipeLocked=false;
document.addEventListener('touchstart',e=>{
  swipeStartX=e.touches[0].clientX;swipeStartY=e.touches[0].clientY;swipeLocked=false;
},{passive:true});
document.addEventListener('touchend',e=>{
  if(swipeLocked)return;
  const dx=e.changedTouches[0].clientX-swipeStartX;
  const dy=e.changedTouches[0].clientY-swipeStartY;
  if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*2){
    const idx=TABS.indexOf(S.tab);
    if(dx<0&&idx<TABS.length-1){goTab(TABS[idx+1]);vib(15);}
    else if(dx>0&&idx>0){goTab(TABS[idx-1]);vib(15);}
  }
},{passive:true});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  if(!isUnlocked) return;
  const c=document.getElementById('content');
  if(S.tab==='overview') c.innerHTML=renderOverview();
  else if(S.tab==='budget') c.innerHTML=renderBudget();
  else if(S.tab==='daily') c.innerHTML=renderDaily();
  else if(S.tab==='invest') c.innerHTML=renderInvest();
  else if(S.tab==='plan') c.innerHTML=renderPlan();
  const bal=balance();
  const hb=document.getElementById('hdr-bal');
  if(hb){hb.textContent='‚Çµ'+fmt(bal);hb.style.color=bal>=0?'#F9A825':'#EF5350';}
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===S.tab));
  updateAlert();
}
function goTab(t){S.tab=t;S.planDrop=false;save();render();const c=document.getElementById('content');if(c)c.scrollTop=0;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview() {
  const tb=totalBudget(),ts=totalSpent(),bal=balance();
  const inv=INV_VEHICLES.reduce((a,i)=>a+i.monthly*S.invMonth,0);
  const gPct=Math.min(inv/10000*100,100);
  const daily=dailyTotal();

  let html=`
  <!-- Month header + reset -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
    <div>
      <div style="font-size:12px;font-weight:700;color:var(--gold)">${S.currentMonthLabel}</div>
      <div style="font-size:10px;color:var(--muted)">Current month</div>
    </div>
    <button onclick="openResetModal()" style="background:rgba(249,168,37,0.1);border:1px solid rgba(249,168,37,0.3);border-radius:9px;padding:7px 12px;color:var(--gold);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">üìÖ New Month</button>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    ${[
      {lbl:'Monthly Income',val:INCOME,color:'#4CAF50',icon:'üí∞'},
      {lbl:'Total Budgeted',val:tb,color:'#42A5F5',icon:'üìã'},
      {lbl:'Total Spent',val:ts,color:ts>tb?'#EF5350':'#F9A825',icon:'üí∏'},
      {lbl:'Live Balance',val:bal,color:bal>=0?'#F9A825':'#EF5350',icon:'üíµ',glow:true},
    ].map(k=>`<div class="kpi-card${k.glow?' glow':''}"><div class="kpi-icon">${k.icon}</div><div class="kpi-val" style="color:${k.color}">‚Çµ${fmt(k.val)}</div><div class="kpi-lbl">${k.lbl}</div></div>`).join('')}
  </div>

  <!-- Category rings overview -->
  <div class="card">
    <div class="card-title">Budget by Category</div>
    ${SECTIONS.map(s=>{
      const sb=secBudget(s.id),sa=secActual(s.id),pct=Math.round(sb/INCOME*100);
      const diff=sb-sa;
      const usePct=sb>0?Math.min(sa/sb*100,100):0;
      const r=28,circ=2*Math.PI*r,dash=circ*(usePct/100),gap=circ-dash;
      const over=sa>sb&&sa>0;
      const near=sa>=sb*0.8&&sa<sb&&sa>0;
      const alertDot=over?`<span class="alert-dot" style="background:#EF5350"></span>`:near?`<span class="alert-dot" style="background:#F9A825"></span>`:'';
      return `<div class="sec-row">
        <div class="sec-l">
          <div class="ring-wrap" style="width:62px;height:62px;flex-shrink:0">
            <svg class="ring-svg" width="62" height="62" viewBox="0 0 70 70">
              <circle class="ring-bg" cx="35" cy="35" r="${r}"/>
              <circle class="ring-fg" cx="35" cy="35" r="${r}" stroke="${over?'#EF5350':s.color}"
                stroke-dasharray="${dash} ${gap}" stroke-dashoffset="0"/>
            </svg>
            <div class="ring-label"><div class="ring-pct" style="color:${over?'#EF5350':s.color}">${Math.round(usePct)}%</div><div class="ring-sub">${s.icon}</div></div>
          </div>
          <div>
            <div class="sec-name">${s.label}${alertDot}</div>
            <div class="sec-sub">‚Çµ${fmt(sb)} ¬∑ ${pct}% income</div>
            ${sa>0?`<div style="font-size:10px;color:${diff>=0?'#4CAF50':'#EF5350'};margin-top:1px">${diff>=0?'‚Çµ'+fmt(diff)+' left':'‚Çµ'+fmt(Math.abs(diff))+' over'}</div>`:''}
          </div>
        </div>
        <div class="sec-r">
          <div class="sec-amt" style="color:${s.color}">‚Çµ${fmt(sa||0)}</div>
          <div style="font-size:10px;color:var(--muted)">spent</div>
        </div>
      </div>`;
    }).join('')}
  </div>

  <!-- Spending bar -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:9px">
      <div class="card-title" style="margin:0">Spending Mix</div>
      <div style="font-size:11px;color:var(--muted)">‚Çµ${fmt(ts)} of ‚Çµ${fmt(INCOME)}</div>
    </div>
    <div style="display:flex;height:13px;border-radius:99px;overflow:hidden;gap:1px">
      ${SECTIONS.map(s=>`<div style="width:${secBudget(s.id)/INCOME*100}%;background:${s.color};opacity:0.82" title="${s.label}"></div>`).join('')}
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:5px 11px;margin-top:9px">
      ${SECTIONS.map(s=>`<div style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted)"><div style="width:7px;height:7px;border-radius:2px;background:${s.color}"></div>${s.icon} ${s.label}</div>`).join('')}
    </div>
  </div>

  <!-- Investment goal ring -->
  <div class="card glow">
    <div class="card-title">Investment Goal</div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:13px">
      <div class="ring-wrap" style="width:90px;height:90px;flex-shrink:0">
        ${(()=>{const r=38,circ=2*Math.PI*r,dash=circ*(gPct/100),gap=circ-dash;
        return `<svg class="ring-svg" width="90" height="90" viewBox="0 0 90 90">
          <circle class="ring-bg" cx="45" cy="45" r="${r}" stroke-width="10"/>
          <circle class="ring-fg" cx="45" cy="45" r="${r}" stroke="${gPct>=100?'#4CAF50':'#F9A825'}"
            stroke-dasharray="${dash} ${gap}" stroke-width="10" stroke-dashoffset="0"/>
        </svg>
        <div class="ring-label"><div style="font-size:18px;font-weight:900;color:${gPct>=100?'#4CAF50':'#F9A825'}">${Math.round(gPct)}%</div><div style="font-size:9px;color:var(--muted)">goal</div></div>`})()}
      </div>
      <div style="flex:1">
        <div style="font-size:24px;font-weight:900;color:#F9A825;letter-spacing:-1px">‚Çµ${fmt(inv)}</div>
        <div style="font-size:11px;color:var(--muted)">by month ${S.invMonth}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px">Target: ‚Çµ10,000</div>
        ${gPct>=100?`<div style="color:#4CAF50;font-weight:800;font-size:13px;margin-top:4px">üéâ Goal achieved!</div>`:''}
      </div>
    </div>
    <div class="slider-row">
      <span style="font-size:12px;color:var(--muted)">Simulate month <strong style="color:#F9A825">${S.invMonth}</strong></span>
      <span style="font-size:11px;color:#F9A825">‚Çµ${fmt(10000-inv)} to go</span>
    </div>
    <input type="range" min="1" max="6" value="${S.invMonth}" oninput="setInvMo(this.value)">
    <div class="m-ticks">${[1,2,3,4,5,6].map(m=>`<span class="m-tick${m==S.invMonth?' on':''}" onclick="setInvMo(${m})">M${m}</span>`).join('')}</div>
  </div>

  <!-- Daily expenses summary if any -->
  ${S.dailyExpenses.length>0?`
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
      <div class="card-title" style="margin:0">Recent Daily Expenses</div>
      <button onclick="goTab('daily')" style="background:rgba(249,168,37,0.15);border:1px solid rgba(249,168,37,0.3);border-radius:8px;padding:5px 10px;color:#F9A825;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">View All ‚Üí</button>
    </div>
    ${[...S.dailyExpenses].reverse().slice(0,3).map(e=>`
    <div style="display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid #1a332025">
      <div style="width:30px;height:30px;border-radius:8px;background:${CAT_COLORS[e.cat]||'#F9A825'}22;border:1px solid ${CAT_COLORS[e.cat]||'#F9A825'}40;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${CAT_ICONS[e.cat]||'üßæ'}</div>
      <div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.desc}</div><div style="font-size:11px;color:var(--muted)">${fmtDate(e.date)} ¬∑ ${e.cat||'other'}</div></div>
      <div style="font-size:14px;font-weight:800;color:#F9A825">‚Çµ${fmt(e.amount)}</div>
    </div>`).join('')}
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:9px;padding-top:7px;border-top:1px solid #1a3320">
      <span style="font-size:12px;color:var(--muted)">${S.dailyExpenses.length} entries this month</span>
      <span style="font-size:13px;font-weight:800;color:#F9A825">‚Çµ${fmt(daily)} total</span>
    </div>
  </div>`:''}

  <!-- Monthly history -->
  ${S.monthHistory.length>0?`
  <div class="card">
    <div class="card-title">Monthly History</div>
    ${S.monthHistory.slice().reverse().map(h=>{
      const saved=h.income-(h.totalSpent||0);
      return `<div class="hist-card">
        <div><div class="hist-month">${h.month}</div><div style="font-size:11px;color:var(--muted)">Income: ‚Çµ${fmt(h.income)}</div></div>
        <div class="hist-stats">
          <div class="hist-stat"><div class="hist-stat-val" style="color:#EF5350">‚Çµ${fmt(h.totalSpent||0)}</div><div class="hist-stat-lbl">Spent</div></div>
          <div class="hist-stat"><div class="hist-stat-val" style="color:${saved>=0?'#4CAF50':'#EF5350'}">‚Çµ${fmt(Math.abs(saved))}</div><div class="hist-stat-lbl">${saved>=0?'Saved':'Over'}</div></div>
        </div>
        <span class="hist-badge ${saved>=0?'saved-pos':'saved-neg'}">${saved>=0?'+‚Çµ'+fmt(saved):'-‚Çµ'+fmt(Math.abs(saved))}</span>
      </div>`;
    }).join('')}
  </div>`:''}`;

  return html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUDGET TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBudget() {
  const tb=totalBudget(),ba=budgetActualsTotal(),bal=INCOME-ba;
  let html=`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
    <div style="font-size:12px;color:var(--muted)">Tap üíô budget to edit ¬∑ tap actual to enter spent</div>
    <div style="background:rgba(249,168,37,0.15);border:1px solid rgba(249,168,37,0.3);border-radius:9px;padding:5px 11px;font-size:13px;font-weight:700;color:#F9A825">‚Çµ${fmt(balance())}</div>
  </div>`;

  SECTIONS.forEach(s=>{
    const sb=secBudget(s.id),sa=secActual(s.id),diff=sb-sa;
    html+=`<div class="card">
      <div class="bsh">
        <div class="bsh-l">
          <div style="font-size:17px">${s.icon}</div>
          <div><div class="bsh-ttl" style="color:${s.color}">${s.label}</div>${s.endsJune?'<div style="font-size:10px;color:#EF5350;font-weight:600">‚ö° Ends June</div>':''}</div>
        </div>
        <div>
          <div class="bsh-tot" style="color:${s.color}">‚Çµ${fmt(sb)}</div>
          ${sa>0?`<div style="font-size:11px;color:${diff>=0?'#4CAF50':'#EF5350'};text-align:right">${diff>=0?'‚Çµ'+fmt(diff)+' left':'‚Çµ'+fmt(Math.abs(diff))+' over'}</div>`:''}
        </div>
      </div>
      <div style="margin:8px 0 9px">${pb(sa,sb,s.color,5)}</div>
      <div style="display:grid;grid-template-columns:1fr 64px 72px 50px 26px;gap:2px;font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;padding-bottom:6px;border-bottom:1px solid #1a332030">
        <span>Item</span><span style="text-align:right">Budget</span><span style="text-align:center">Actual</span><span style="text-align:right">Diff</span><span></span>
      </div>
      ${s.items.map((item,idx)=>{
        const key=s.id+'_'+item.n;
        const actual=S.actuals[key]||0;
        const d=item.b-actual;
        const sn=item.n.replace(/'/g,"\\'").replace(/"/g,'&quot;');
        return `<div class="budget-5col">
          <div style="cursor:pointer" onclick="openBudOv('${s.id}',${idx},'edit')">
            <div style="font-size:12px;font-weight:600;color:var(--text)">${item.n}</div>
            ${item.notes?`<div class="notes-field">${item.notes}</div>`:''}
          </div>
          <div style="text-align:right"><span class="bud-editable" onclick="openBudOv('${s.id}',${idx},'edit')">‚Çµ${fmt(item.b)}</span></div>
          <div><button class="act-btn${actual>0?' has':''}" onclick="openActOv('${s.id}','${sn}',${item.b})">${actual>0?'‚Çµ'+fmt(actual):'‚Çµ0'}</button></div>
          <div class="diff-${actual===0?'none':d>=0?'pos':'neg'}" style="text-align:right;font-size:11px;font-weight:600">${actual===0?'‚Äî':d>=0?'+‚Çµ'+fmt(d):'-‚Çµ'+fmt(Math.abs(d))}</div>
          <button class="del-btn" onclick="delItem('${s.id}',${idx})">√ó</button>
        </div>`;
      }).join('')}
      <button class="add-item-btn" onclick="openBudOv('${s.id}',-1,'add')">Ôºã Add item</button>
    </div>`;
  });

  html+=`<div class="grand-bar">
    <div style="font-size:14px;font-weight:800;color:#fff;margin-bottom:3px">üìä TOTAL EXPENSES</div>
    <div class="gt-row"><span class="gt-lbl">Budgeted</span><span class="gt-val" style="color:#F9A825">‚Çµ${fmt(tb)}</span></div>
    <div class="gt-row"><span class="gt-lbl">Actual (budget items)</span><span class="gt-val" style="color:var(--text)">‚Çµ${fmt(ba)}</span></div>
    <div class="gt-row"><span class="gt-lbl">Daily Expenses</span><span class="gt-val" style="color:#FFA726">‚Çµ${fmt(dailyTotal())}</span></div>
    <div style="height:1px;background:#1a3320;margin:4px 0"></div>
    <div class="gt-row"><span style="font-size:12px;color:#fff;font-weight:700">Remaining Balance</span>
      <span style="font-size:21px;font-weight:900;color:${balance()>=0?'#F9A825':'#EF5350'}">‚Çµ${fmt(balance())}</span></div>
  </div>
  <!-- Export CSV -->
  <button onclick="exportCSV()" style="width:100%;margin-top:10px;padding:12px;border-radius:11px;background:rgba(66,165,245,0.1);border:1px solid rgba(66,165,245,0.3);color:#42A5F5;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:7px">üì• Export to CSV</button>`;
  return html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY EXPENSES TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDaily() {
  const today=todayStr(),week=new Date(Date.now()-7*86400000).toISOString().slice(0,10),mon=monthStr();
  function filt(arr){switch(S.dailyFilter){case'today':return arr.filter(e=>e.date===today);case'week':return arr.filter(e=>e.date>=week);case'month':return arr.filter(e=>e.date.startsWith(mon));default:return arr;}}
  const filtered=filt(S.dailyExpenses);
  const fTotal=filtered.reduce((a,e)=>a+e.amount,0);
  const todayT=S.dailyExpenses.filter(e=>e.date===today).reduce((a,e)=>a+e.amount,0);
  const monT=S.dailyExpenses.filter(e=>e.date.startsWith(mon)).reduce((a,e)=>a+e.amount,0);
  const sorted=[...filtered].sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const cats=['food','transport','personal','health','social','shopping','bills','other'];

  return `
  <div class="day-stats">
    <div class="day-stat"><div class="day-stat-val" style="color:#F9A825">‚Çµ${fmt(todayT)}</div><div class="day-stat-lbl">Today</div></div>
    <div class="day-stat"><div class="day-stat-val" style="color:#42A5F5">‚Çµ${fmt(monT)}</div><div class="day-stat-lbl">This Month</div></div>
    <div class="day-stat"><div class="day-stat-val" style="color:#4CAF50">${S.dailyExpenses.length}</div><div class="day-stat-lbl">Entries</div></div>
  </div>

  <div class="exp-form">
    <div class="card-title" style="margin-bottom:12px">‚ú¶ Log New Expense</div>
    <div class="exp-field"><div class="exp-lbl">Description</div>
      <input class="exp-inp" id="exp-desc" type="text" placeholder="e.g. Lunch at Papaye" maxlength="60"></div>
    <div class="exp-field"><div class="exp-lbl">Category</div>
      <div class="exp-cat-grid">
        ${cats.map(c=>`<button class="exp-cat-btn${S.dailyExpCat===c?' sel':''}" onclick="setExpCat('${c}')">${CAT_ICONS[c]} ${c}</button>`).join('')}
      </div>
    </div>
    <div class="exp-2col">
      <div class="exp-field"><div class="exp-lbl">Amount (‚Çµ)</div>
        <input class="exp-inp" id="exp-amt" type="number" inputmode="decimal" placeholder="0.00"></div>
      <div class="exp-field"><div class="exp-lbl">Date</div>
        <input class="exp-inp" id="exp-date" type="date" value="${today}"></div>
    </div>
    <button class="btn-add-exp" onclick="addExp()"><span>‚ú¶</span> Log Expense</button>
  </div>

  <div class="filter-bar">
    ${['all','today','week','month'].map(f=>`<button class="f-chip${S.dailyFilter===f?' on':''}" onclick="setDailyFilter('${f}')">${f==='all'?'All time':f==='today'?'Today':f==='week'?'This week':'This month'}</button>`).join('')}
  </div>

  ${sorted.length===0?`<div style="text-align:center;padding:36px 20px;color:var(--muted)"><div style="font-size:34px;margin-bottom:11px">üßæ</div><div style="font-size:14px;font-weight:600">No expenses yet</div><div style="font-size:12px;margin-top:3px">Log your first expense above</div></div>`:`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-size:12px;color:var(--muted)">${sorted.length} expense${sorted.length!==1?'s':''}</div>
    <div style="font-size:13px;font-weight:800;color:#F9A825">‚Çµ${fmt(fTotal)} total</div>
  </div>
  ${sorted.map(e=>`
  <div class="exp-card">
    <div class="exp-ico" style="background:${CAT_COLORS[e.cat]||'#F9A825'}20;border:1px solid ${CAT_COLORS[e.cat]||'#F9A825'}35">${CAT_ICONS[e.cat]||'üßæ'}</div>
    <div class="exp-info"><div class="exp-desc">${e.desc}</div><div class="exp-meta">${fmtDate(e.date)} ¬∑ ${e.cat||'other'}</div></div>
    <div class="exp-amt">‚Çµ${fmt(e.amount)}</div>
    <button class="exp-del" onclick="delExp(${e.id})">√ó</button>
  </div>`).join('')}`}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVESTMENTS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInvest() {
  const inv=INV_VEHICLES.reduce((a,i)=>a+i.monthly*S.invMonth,0);
  const gPct=Math.min(inv/10000*100,100);
  return `
  <div class="inv-grid">${INV_VEHICLES.map(v=>`
    <div class="inv-card">
      <div class="inv-name">${v.name}</div>
      <div class="inv-val" style="color:${v.color}">‚Çµ${fmt(v.monthly*S.invMonth)}</div>
      <div class="inv-sub">‚Çµ${fmt(v.monthly)}/mo √ó M${S.invMonth}</div>
      ${pb(v.monthly*S.invMonth,v.monthly*6,v.color,5)}
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:3px"><span>M${S.invMonth}</span><span>6-Mo: ‚Çµ${fmt(v.monthly*6)}</span></div>
    </div>`).join('')}
  </div>
  <div class="card glow">
    <div class="card-title">Growth Simulator</div>
    <div class="slider-row" style="margin-bottom:5px">
      <span style="font-size:12px;color:var(--muted)">Month <strong style="color:#F9A825">${S.invMonth}</strong></span>
      <span style="font-size:12px;color:#F9A825;font-weight:700">‚Çµ${fmt(inv)} total</span>
    </div>
    <input type="range" min="1" max="6" value="${S.invMonth}" oninput="setInvMo(this.value)">
    <div class="m-ticks">${[1,2,3,4,5,6].map(m=>`<span class="m-tick${m==S.invMonth?' on':''}" onclick="setInvMo(${m})">M${m}</span>`).join('')}</div>
    <div style="margin-top:13px">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px">
        <span style="font-size:12px;color:var(--muted)">Progress to ‚Çµ10,000 Goal</span>
        <span style="font-size:12px;color:#F9A825;font-weight:700">${Math.round(gPct)}%</span>
      </div>
      ${pb(inv,10000,'#F9A825',13)}
      ${gPct>=100?`<div style="text-align:center;color:#F9A825;font-weight:800;margin-top:7px">üéâ Goal Achieved at Month ${S.invMonth}!</div>`
        :`<div style="text-align:center;font-size:11px;color:var(--muted);margin-top:5px">‚Çµ${fmt(10000-inv)} remaining</div>`}
    </div>
  </div>
  <div class="card">
    <div class="card-title">Month-by-Month Table</div>
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
      <table style="width:100%;border-collapse:collapse;font-size:11px">
        <thead><tr style="border-bottom:1px solid var(--border)">
          <th style="text-align:left;padding:5px 5px;color:var(--muted);font-size:10px">Vehicle</th>
          ${[1,2,3,4,5,6].map(m=>`<th style="text-align:right;padding:5px 4px;color:${m==S.invMonth?'#F9A825':'var(--muted)'};font-size:10px${m==S.invMonth?';font-weight:700':''}">M${m}</th>`).join('')}
        </tr></thead>
        <tbody>
          ${INV_VEHICLES.map((v,i)=>`<tr style="border-bottom:1px solid #1a332025;background:${i%2===0?'rgba(255,255,255,0.01)':'transparent'}">
            <td style="padding:7px 5px;color:${v.color};font-weight:600">${v.name}</td>
            ${[1,2,3,4,5,6].map(m=>`<td style="text-align:right;padding:7px 4px;color:${m==S.invMonth?'#F9A825':'var(--text)'}${m==S.invMonth?';font-weight:700;background:rgba(249,168,37,0.07)':''}">‚Çµ${fmt(v.monthly*m)}</td>`).join('')}
          </tr>`).join('')}
          <tr style="border-top:2px solid var(--border);font-weight:800">
            <td style="padding:7px 5px;color:#F9A825">TOTAL</td>
            ${[1,2,3,4,5,6].map(m=>{const t=INV_VEHICLES.reduce((a,v)=>a+v.monthly*m,0);return`<td style="text-align:right;padding:7px 4px;color:${m==S.invMonth?'#F9A825':'#4CAF50'}${m==S.invMonth?';font-weight:800;background:rgba(249,168,37,0.09)':''}">‚Çµ${fmt(t)}</td>`;}).join('')}
          </tr>
        </tbody>
      </table>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MONTHLY PLAN TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPlan() {
  const opt=MONTH_OPTS[S.planIdx];
  const{rows,totalOut,after,mnum}=getPlan(opt.month,opt.year);
  const bal=INCOME-totalOut;
  const years=[...new Set(MONTH_OPTS.map(o=>o.year))];
  const filtered=S.planYear?MONTH_OPTS.filter(o=>o.year===S.planYear):MONTH_OPTS;
  const phC=after?'#F9A825':'#4CAF50';
  const phBg=after?'rgba(249,168,37,0.14)':'rgba(76,175,80,0.14)';
  const phTxt=after?'‚ö° Wealth Acceleration':'üå± Foundation Building';
  const mInv=after?2600:2000;
  const cumInv=mInv*(mnum+1);
  const iGPct=Math.min(cumInv/10000*100,100);

  return `
  <button class="plan-sel-btn${S.planDrop?' open':''}" onclick="togglePlanDrop()">
    <div class="psl"><div class="ps-ico">üìÖ</div>
      <div><div class="ps-name">${opt.label}</div><div class="ps-sub">Month ${mnum+1} ¬∑ ${after?'July+ active':'Jan‚ÄìJune active'}</div></div>
    </div>
    <span class="chev${S.planDrop?' open':''}">‚ñæ</span>
  </button>

  ${S.planDrop?`<div class="plan-drop">
    <div class="yr-tabs">
      <button class="yr-tab${!S.planYear?' on':''}" onclick="setPlanYr(null)">All</button>
      ${years.map(y=>`<button class="yr-tab${S.planYear===y?' on':''}" onclick="setPlanYr(${y})">${y}</button>`).join('')}
    </div>
    <div class="mo-list">
      ${filtered.map(o=>{const ri=MONTH_OPTS.indexOf(o),isSel=ri===S.planIdx,isSw=o.month===6&&o.year===2026,isPost=isAfterJune(o.month,o.year);
      return`<button class="mo-opt${isSel?' sel':''}" onclick="selPlanMo(${ri})">
        <div class="mo-l"><div class="mo-dot" style="background:${isSel?'#F9A825':isPost?'#4CAF50':'var(--muted)'}"></div><span class="mo-name">${o.label}</span></div>
        <div style="display:flex;align-items:center;gap:5px">${isSw?'<span class="mo-badge badge-sw">SWITCH</span>':''}${isPost&&!isSw?'<span class="mo-badge badge-ac">ACCEL</span>':''}${isSel?'<span style="color:#F9A825;font-size:12px">‚úì</span>':''}</div>
      </button>`;}).join('')}
    </div>
    <div class="drop-leg">
      <div class="leg-i"><div class="leg-d" style="background:var(--muted)"></div>Jan‚ÄìJune</div>
      <div class="leg-i"><div class="leg-d" style="background:#4CAF50"></div>July+</div>
      <div class="leg-i"><div class="leg-d" style="background:#F9A825"></div>Selected</div>
    </div>
  </div>`:''}

  <div class="phase-badge" style="background:${phBg};border:1px solid ${phC}40">
    <div class="p-dot" style="background:${phC};box-shadow:0 0 5px ${phC}"></div>
    <span style="color:${phC}">${phTxt}</span>
    <span style="color:var(--muted)">¬∑ ${opt.label}</span>
  </div>

  <div class="plan-stats">
    ${[{icon:'üí∏',val:`‚Çµ${fmt(totalOut)}`,lbl:'Total Out',c:'#EF5350'},{icon:'üíµ',val:`‚Çµ${fmt(bal)}`,lbl:'Balance',c:bal>=0?'#4CAF50':'#EF5350'},{icon:'üìÖ',val:`Month ${mnum+1}`,lbl:'Plan Month',c:'#F9A825'}]
    .map(s=>`<div class="ps-stat"><div style="font-size:17px;margin-bottom:3px">${s.icon}</div><div class="ps-sv" style="color:${s.c}">${s.val}</div><div class="ps-sl">${s.lbl}</div></div>`).join('')}
  </div>

  ${coll('breakdown',`${opt.label} Budget Breakdown`,`${after?'July+ optimized':'Jan‚ÄìJune foundation'} ¬∑ ‚Çµ${fmt(totalOut)} total`,'üìã','rgba(249,168,37,0.14)','rgba(249,168,37,0.28)','#F9A825',`
    <div class="plan-tbl-hdr"><span>Category</span><span>Jan‚ÄìJun</span><span>This Mo</span><span>Change</span></div>
    ${rows.map((r,i)=>{const diff=r.current-r.before;return`<div class="plan-row" style="background:${i%2===0?'rgba(255,255,255,0.01)':'transparent'}">
      <div class="pr-l"><span style="font-size:14px">${r.icon}</span><div><div class="pr-name">${r.label}</div>${r.ended?`<div class="pr-sub" style="color:#4CAF50">‚úÖ Ended</div>`:''}${r.change&&!r.ended?`<div class="pr-sub" style="color:#F9A825">${r.change}</div>`:''}</div></div>
      <span style="color:var(--muted)">‚Çµ${fmt(r.before)}</span>
      <span style="color:${r.current===0?'var(--muted)':r.color}">${r.current===0?'‚Äî':'‚Çµ'+fmt(r.current)}</span>
      <span style="color:${diff===0?'var(--muted)':diff<0?'#4CAF50':'#F9A825'}">${diff===0?'‚Äî':diff<0?'-‚Çµ'+fmt(Math.abs(diff)):'+‚Çµ'+fmt(diff)}</span>
    </div>`;}).join('')}
    <div class="plan-tot-row"><span>TOTAL</span><span style="color:var(--muted)">‚Çµ${fmt(rows.reduce((a,r)=>a+r.before,0))}</span><span style="color:#F9A825">‚Çµ${fmt(totalOut)}</span><span style="color:${bal>=0?'#4CAF50':'#EF5350'}">${bal>=0?'+‚Çµ'+fmt(bal):'-‚Çµ'+fmt(Math.abs(bal))}</span></div>
    <div class="plan-bal"><span style="font-size:13px;font-weight:700;color:var(--text)">üíµ Remaining Balance</span><span style="font-size:17px;font-weight:900;color:${bal>=0?'#F9A825':'#EF5350'}">‚Çµ${fmt(bal)}</span></div>
  `)}

  ${after?coll('redirect','‚Çµ2,000 Freed ‚Äî Redirection','Where former personal payments now go','üîì','rgba(249,168,37,0.14)','rgba(249,168,37,0.28)','#F9A825',`
    <div class="redir-grid">${REDIRECTIONS.map(r=>`<div class="redir-card"><div class="rc-ico">${r.icon}</div><div class="rc-amt">‚Çµ${r.amount}</div><div class="rc-pct">${r.pct}</div><div class="rc-lbl">${r.label}</div></div>`).join('')}</div>
    <div class="plan-bal"><span style="font-size:13px;font-weight:700;color:var(--text)">Total Redirected</span><span style="font-size:17px;font-weight:900;color:#F9A825">‚Çµ2,000/month</span></div>
  `):''}

  ${!after?coll('preview','What changes after June 2026?','Preview the July+ acceleration plan','üöÄ','rgba(76,175,80,0.14)','rgba(76,175,80,0.28)','#4CAF50',`
    <div style="background:rgba(249,168,37,0.1);border:1px solid rgba(249,168,37,0.28);border-radius:11px;padding:13px;margin-bottom:13px">
      <div style="font-size:14px;font-weight:800;color:#F9A825;margin-bottom:5px">‚ö° July 2026: The Switch</div>
      <div style="font-size:12px;color:var(--text);line-height:1.6">Personal payments of <strong style="color:#EF5350">‚Çµ2,000 end</strong> after June. All redirected to wealth-building.</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      ${[{l:'Investments',b:'‚Çµ2,000',a:'‚Çµ2,600',c:'+30%'},{l:'Savings',b:'‚Çµ850',a:'‚Çµ1,350',c:'+59%'},{l:'Personal Payments',b:'‚Çµ2,000',a:'‚Çµ0',c:'ENDED'},{l:'Monthly Balance',b:'‚Çµ-350',a:'‚Çµ+250',c:'FREED'}]
      .map(item=>`<div style="background:rgba(13,31,16,0.5);border:1px solid var(--border);border-radius:9px;padding:11px">
        <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-bottom:5px">${item.l}</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="text-align:center"><div style="font-size:9px;color:var(--muted)">Now</div><div style="font-size:13px;font-weight:700;color:var(--text)">${item.b}</div></div>
          <span style="color:#F9A825">‚Üí</span>
          <div style="text-align:center"><div style="font-size:9px;color:var(--muted)">July+</div><div style="font-size:13px;font-weight:700;color:#F9A825">${item.a}</div></div>
          <div style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:${item.c==='ENDED'?'rgba(76,175,80,0.2)':'rgba(249,168,37,0.2)'};color:${item.c==='ENDED'?'#4CAF50':'#F9A825'}">${item.c}</div>
        </div>
      </div>`).join('')}
    </div>
  `):''}

  ${coll('invprog','Investment Progress',`Cumulative by ${opt.label}`,'üìà','rgba(76,175,80,0.14)','rgba(76,175,80,0.28)','#4CAF50',`
    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:7px">
      <div><div style="font-size:24px;font-weight:900;color:#F9A825;letter-spacing:-1px">‚Çµ${fmt(cumInv)}</div><div style="font-size:11px;color:var(--muted)">by ${opt.label}</div></div>
      <div style="text-align:right"><div style="font-size:19px;font-weight:800;color:${iGPct>=100?'#4CAF50':'#F9A825'}">${Math.round(iGPct)}%</div><div style="font-size:11px;color:var(--muted)">of ‚Çµ10,000</div></div>
    </div>
    ${pb(cumInv,10000,'#F9A825',11)}
    ${iGPct>=100?`<div style="text-align:center;color:#F9A825;font-weight:800;margin-top:7px">üéâ Goal achieved by ${opt.label}!</div>`
      :`<div style="text-align:center;font-size:11px;color:var(--muted);margin-top:5px">‚Çµ${fmt(10000-cumInv)} to go</div>`}
    <div class="inv-prog-grid">
      ${[{n:'Stocks & ETFs',m:1000},{n:'T-Bills',m:after?650:500},{n:'Money Market',m:after?550:300},{n:'Mutual Fund',m:after?400:200}]
      .map(v=>`<div class="ipc"><div class="ipc-name">${v.n}</div><div class="ipc-val">‚Çµ${fmt(v.m*(mnum+1))}</div><div class="ipc-sub">‚Çµ${v.m}/mo</div></div>`).join('')}
    </div>
  `)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pb(val,max,color,h=6){
  const pct=max>0?Math.min(val/max*100,100):0;
  const over=max>0&&val>max;
  return`<div class="prog-track" style="height:${h}px"><div class="prog-fill" style="width:${pct}%;background:${over?'#EF5350':color};height:${h}px"></div></div>`;
}
function coll(key,title,sub,icon,bg,border,color,inner){
  const open=S.colls[key];
  return`<div class="coll${open?' open':''}" id="coll-${key}">
    <button class="coll-hdr" onclick="togColl('${key}')">
      <div class="coll-l"><div class="coll-ico" style="background:${bg};border:1px solid ${border}">${icon}</div>
        <div><div class="coll-ttl">${title}</div><div class="coll-sub">${sub}</div></div></div>
      <div class="coll-chev" style="background:${bg};border:1px solid ${border};color:${color}">‚ñæ</div>
    </button>
    <div class="coll-body"><div class="coll-inner">${inner}</div></div>
  </div>`;
}
function fmtDate(d){
  const t=todayStr(),y=new Date(Date.now()-86400000).toISOString().slice(0,10);
  if(d===t)return'Today';if(d===y)return'Yesterday';
  return new Date(d+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setInvMo(v){S.invMonth=parseInt(v);save();render();}
function togColl(k){S.colls[k]=!S.colls[k];render();}
function togglePlanDrop(){S.planDrop=!S.planDrop;render();if(S.planDrop)setTimeout(()=>{const c=document.getElementById('content');if(c)c.scrollTop=0;},10);}
function setPlanYr(y){S.planYear=y;render();}
function selPlanMo(i){S.planIdx=i;S.planDrop=false;S.planYear=null;save();render();}
function setDailyFilter(f){S.dailyFilter=f;render();}
function setExpCat(c){S.dailyExpCat=c;render();}

// Actual overlay
let _actKey=null;
function openActOv(sid,name,budget){
  _actKey=sid+'_'+name;
  const cur=S.actuals[_actKey]||0;
  document.getElementById('act-cat').textContent=SECTIONS.find(s=>s.id===sid)?.label||sid;
  document.getElementById('act-item').textContent=name;
  const inp=document.getElementById('act-inp');
  inp.value=cur>0?cur:'';inp.placeholder=`Budget: ‚Çµ${budget}`;
  document.getElementById('act-ov').classList.add('open');
  setTimeout(()=>inp.focus(),350);vib(20);
}
function closeActOv(e){if(e&&e.target!==document.getElementById('act-ov'))return;document.getElementById('act-ov').classList.remove('open');_actKey=null;}
function saveAct(){const v=parseFloat(document.getElementById('act-inp').value)||0;if(_actKey){S.actuals[_actKey]=v;save();}document.getElementById('act-ov').classList.remove('open');_actKey=null;render();vib(30);}
document.getElementById('act-inp').addEventListener('keydown',e=>{if(e.key==='Enter')saveAct();if(e.key==='Escape')closeActOv();});

// Budget item overlay
let _bSid=null,_bIdx=null,_bMode=null;
function openBudOv(sid,idx,mode){
  _bSid=sid;_bIdx=idx;_bMode=mode;
  const sec=SECTIONS.find(s=>s.id===sid);
  document.getElementById('bud-sec-lbl').textContent=sec?.label||sid;
  document.getElementById('bud-mode-ttl').textContent=mode==='add'?'Add New Budget Item':'Edit Budget Item';
  document.getElementById('bud-save-btn').textContent=mode==='add'?'Add Item':'Save Changes';
  if(mode==='edit'&&idx>=0){const it=sec.items[idx];document.getElementById('bud-name').value=it.n;document.getElementById('bud-amt').value=it.b;document.getElementById('bud-notes').value=it.notes||'';}
  else{document.getElementById('bud-name').value='';document.getElementById('bud-amt').value='';document.getElementById('bud-notes').value='';}
  document.getElementById('bud-ov').classList.add('open');setTimeout(()=>document.getElementById('bud-name').focus(),350);vib(20);
}
function closeBudOv(e){if(e&&e.target!==document.getElementById('bud-ov'))return;document.getElementById('bud-ov').classList.remove('open');_bSid=null;_bIdx=null;_bMode=null;}
function saveBudItem(){
  const name=document.getElementById('bud-name').value.trim();
  const amt=parseFloat(document.getElementById('bud-amt').value);
  const notes=document.getElementById('bud-notes').value.trim();
  if(!name||!amt||amt<=0)return;
  const sec=SECTIONS.find(s=>s.id===_bSid);if(!sec)return;
  if(_bMode==='add'){sec.items.push({n:name,b:amt,notes});}
  else if(_bMode==='edit'&&_bIdx>=0){
    const old=sec.items[_bIdx].n;
    if(old!==name){const ok=_bSid+'_'+old,nk=_bSid+'_'+name;if(S.actuals[ok]!==undefined){S.actuals[nk]=S.actuals[ok];delete S.actuals[ok];}}
    sec.items[_bIdx]={n:name,b:amt,notes};
  }
  save();document.getElementById('bud-ov').classList.remove('open');_bSid=null;_bIdx=null;_bMode=null;render();vib(30);
  showToast(_bMode==='add'?'‚úÖ Item added':'‚úÖ Item updated');
}
function delItem(sid,idx){
  const sec=SECTIONS.find(s=>s.id===sid);if(!sec||!sec.items[idx])return;
  const n=sec.items[idx].n;delete S.actuals[sid+'_'+n];sec.items.splice(idx,1);save();render();vib([30,20]);showToast('üóëÔ∏è Item removed');
}
document.getElementById('bud-name').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('bud-amt').focus();});
document.getElementById('bud-amt').addEventListener('keydown',e=>{if(e.key==='Enter')saveBudItem();if(e.key==='Escape')closeBudOv();});

// Income overlay
function openIncomeEdit(){if(!isUnlocked)return;document.getElementById('inc-inp').value=INCOME;document.getElementById('inc-ov').classList.add('open');setTimeout(()=>document.getElementById('inc-inp').focus(),350);}
function closeIncOv(e){if(e&&e.target!==document.getElementById('inc-ov'))return;document.getElementById('inc-ov').classList.remove('open');}
function saveIncome(){const v=parseFloat(document.getElementById('inc-inp').value);if(v>0){INCOME=v;save();render();}document.getElementById('inc-ov').classList.remove('open');showToast('‚úÖ Income updated');}
document.getElementById('inc-inp').addEventListener('keydown',e=>{if(e.key==='Enter')saveIncome();if(e.key==='Escape')closeIncOv();});

// Daily expenses
function addExp(){
  const desc=document.getElementById('exp-desc')?.value?.trim();
  const amt=parseFloat(document.getElementById('exp-amt')?.value);
  const date=document.getElementById('exp-date')?.value;
  if(!desc){document.getElementById('exp-desc').focus();return;}
  if(!amt||amt<=0){document.getElementById('exp-amt').focus();return;}
  if(!date)return;
  S.dailyExpenses.push({id:Date.now(),desc,amount:amt,date,cat:S.dailyExpCat||'other'});
  save();vib(30);showToast('‚úÖ Expense logged');
  document.getElementById('exp-desc').value='';document.getElementById('exp-amt').value='';
  render();setTimeout(()=>{const c=document.getElementById('content');if(c)c.scrollTop=c.scrollHeight;},60);
}
function delExp(id){S.dailyExpenses=S.dailyExpenses.filter(e=>e.id!==id);save();render();vib([25,15]);showToast('üóëÔ∏è Expense removed');}

// Monthly Reset
function openResetModal(){
  document.getElementById('rm-cur-month').textContent=S.currentMonthLabel;
  document.getElementById('reset-modal').classList.add('open');vib(20);
}
function closeResetModal(){document.getElementById('reset-modal').classList.remove('open');}
function confirmReset(){
  // Archive current month
  S.monthHistory.push({
    month:S.currentMonthLabel,
    income:INCOME,
    totalBudget:totalBudget(),
    totalSpent:totalSpent(),
    dailyCount:S.dailyExpenses.length,
  });
  // Clear for new month
  S.actuals={};S.dailyExpenses=[];
  const n=new Date();S.currentMonthLabel=MONTHS_N[n.getMonth()]+' '+n.getFullYear();
  closeResetModal();save();render();vib([40,20,40]);showToast('üìÖ New month started! History saved.');
}

// CSV Export
function exportCSV(){
  let csv='Type,Category,Item,Budget,Actual,Difference,Date\n';
  SECTIONS.forEach(s=>{
    s.items.forEach(item=>{
      const key=s.id+'_'+item.n;const actual=S.actuals[key]||0;const diff=item.b-actual;
      csv+=`Budget,${s.label},"${item.n}",${item.b},${actual},${diff},${S.currentMonthLabel}\n`;
    });
  });
  S.dailyExpenses.forEach(e=>{csv+=`Daily,${e.cat||'other'},"${e.desc}",,,${e.amount},${e.date}\n`;});
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`sams_finance_${S.currentMonthLabel.replace(' ','_')}.csv`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showToast('üì• CSV exported!');
}

// Plan tab
function togglePlanDrop(){S.planDrop=!S.planDrop;render();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pinBuf='',pinMode='enter',pinFirst='',isUnlocked=false;
function hPin(p){let h=0x5f3759df;for(let i=0;i<p.length;i++){h=((h<<5)-h)+p.charCodeAt(i);h|=0;}return h.toString(36);}
function initPin(){
  const stored=localStorage.getItem('sams_pin');
  if(!stored){pinMode='setup';document.getElementById('pin-sub').textContent='Create a 4-digit PIN to protect your dashboard';document.getElementById('pin-step').style.display='block';document.getElementById('pin-step').textContent='Step 1 of 2 ‚Äî Enter new PIN';document.getElementById('pin-forgot').style.display='none';}
  else{pinMode='enter';document.getElementById('pin-sub').textContent='Enter your PIN to unlock';document.getElementById('pin-step').style.display='none';}
}
function updDots(state){for(let i=0;i<4;i++){const d=document.getElementById('d'+i);d.className='pin-dot';if(i<pinBuf.length)d.classList.add(state==='error'?'error':state==='ok'?'ok':'filled');}}
function showPinErr(msg){const el=document.getElementById('pin-err');el.textContent=msg;el.classList.add('vis');const dots=document.getElementById('pin-dots');dots.classList.add('shake');setTimeout(()=>{dots.classList.remove('shake');el.classList.remove('vis');pinBuf='';updDots('normal');},800);}
function pk(d){if(pinBuf.length>=4)return;pinBuf+=d;updDots('normal');if(pinBuf.length===4)setTimeout(handlePin,120);vib(10);}
function pdel(){if(pinBuf.length>0){pinBuf=pinBuf.slice(0,-1);updDots('normal');document.getElementById('pin-err').classList.remove('vis');}vib(10);}
function handlePin(){
  if(pinMode==='setup'){pinFirst=pinBuf;pinBuf='';pinMode='confirm';document.getElementById('pin-sub').textContent='Confirm your PIN';document.getElementById('pin-step').textContent='Step 2 of 2 ‚Äî Re-enter to confirm';updDots('normal');}
  else if(pinMode==='confirm'){
    if(pinBuf===pinFirst){localStorage.setItem('sams_pin',hPin(pinBuf));updDots('ok');setTimeout(unlockApp,400);}
    else{showPinErr("PINs don't match ‚Äî try again");pinMode='setup';pinFirst='';document.getElementById('pin-sub').textContent='Create a 4-digit PIN';document.getElementById('pin-step').textContent='Step 1 of 2 ‚Äî Enter new PIN';}
  } else {
    const stored=localStorage.getItem('sams_pin');
    if(hPin(pinBuf)===stored){updDots('ok');setTimeout(unlockApp,400);}
    else{showPinErr('Incorrect PIN ‚Äî try again');vib([50,30]);}
  }
}
function unlockApp(){isUnlocked=true;const sc=document.getElementById('pin-screen');sc.classList.add('unlocking');setTimeout(()=>{sc.classList.add('hidden');render();},350);}
function pinReset(){if(confirm('Reset your PIN? You will need to create a new one.')){localStorage.removeItem('sams_pin');pinBuf='';pinFirst='';pinMode='setup';document.getElementById('pin-sub').textContent='Create a 4-digit PIN';document.getElementById('pin-step').style.display='block';document.getElementById('pin-step').textContent='Step 1 of 2 ‚Äî Enter new PIN';document.getElementById('pin-forgot').style.display='none';updDots('normal');document.getElementById('pin-err').classList.remove('vis');}}
let lockTimer;
function resetLock(){clearTimeout(lockTimer);if(isUnlocked)lockTimer=setTimeout(lockApp,5*60*1000);}
function lockApp(){if(!isUnlocked)return;isUnlocked=false;pinBuf='';pinMode='enter';document.getElementById('pin-sub').textContent='Enter your PIN to unlock';document.getElementById('pin-step').style.display='none';document.getElementById('pin-forgot').style.display='block';updDots('normal');document.getElementById('pin-err').classList.remove('vis');document.getElementById('pin-screen').classList.remove('hidden','unlocking');}
document.addEventListener('visibilitychange',()=>{if(document.hidden)resetLock();else clearTimeout(lockTimer);});
document.addEventListener('touchstart',resetLock,{passive:true});
initPin();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTALL PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dismissInstall(){document.getElementById('install-banner').classList.add('hidden');localStorage.setItem('inst_ok','1');}
const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent),isStd=window.navigator.standalone,instDone=localStorage.getItem('inst_ok');
if(isIOS&&!isStd&&!instDone){setTimeout(()=>{document.getElementById('install-banner').classList.remove('hidden');setTimeout(()=>document.getElementById('install-banner').classList.add('hidden'),9000);},2500);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SERVICE WORKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}
</script>
</body>
</html>
